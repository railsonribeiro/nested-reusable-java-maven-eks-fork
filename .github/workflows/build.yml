name: Build Workflow

on:
  workflow_call:
    inputs:
      #variables
      app_name:
        required: true
        type: string
      dockerhub_username:
        required: true
        type: string
      java_version:
        description: "Vers√£o do Java (ex: '17' ou '21')"
        required: false
        type: string
        default: "21"
      #runsteps
      run_validation_and_lint:
        description: "Executar valida√ß√£o e linting"
        required: false
        type: boolean
        default: true
      run_build_and_test:
        description: "Executar build e testes"
        required: false
        type: boolean
        default: true
      run_docker_build_and_push:
        required: false
        type: boolean
        default: true

jobs:
  validation-and-lint:
    name: Validation & Code Quality
    runs-on: ubuntu-latest
    if: inputs.run_validation_and_lint
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Lint Dockerfile
        run: |
          echo "üîç Verificando qualidade do Dockerfile..."
          
           # Verificar se o Dockerfile existe
           if [ ! -f "Dockerfile" ]; then
             echo "‚ùå ERRO: Dockerfile n√£o encontrado no reposit√≥rio"
             exit 1
           fi
          
           echo "‚úÖ Dockerfile encontrado"
          
           # Instalar hadolint se n√£o estiver dispon√≠vel
           if ! command -v hadolint &> /dev/null; then
             echo "üì¶ Instalando hadolint..."
             wget -O hadolint https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64
             chmod +x hadolint
             sudo mv hadolint /usr/local/bin/
           fi
          
           echo "üîç Executando lint no Dockerfile..."
           hadolint Dockerfile 

  build_and_test:
    name: Build & Test
#    needs: validation-and-lint
    if: ${{ inputs.run_build_and_test }}
    runs-on: ubuntu-latest
    outputs:
      build_ok: ${{ steps.build_and_test_step.outcome }}
      app_version: ${{ steps.extract_version.outputs.version }}
      image_tag: ${{ steps.extract_version.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java_version }}
          cache: maven

      - name: Extract Version from pom.xml
        id: extract_version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$VERSION" >> $GITHUB_OUTPUT
          
          echo "üì¶ Vers√£o do pom.xml: $VERSION"
          echo "üè∑Ô∏è  Tag da imagem: $VERSION"

      - name: Build with Maven
        run: | 
          mvn -B clean verify
          echo "Verificando JaCoCo: target/site/jacoco/jacoco.xml"
          if [ -f "target/site/jacoco/jacoco.xml" ]; then
            echo "::notice::Arquivo encontrado"
            ls -la target/site/jacoco/jacoco.xml
            head -n 20 target/site/jacoco/jacoco.xml || true
          else
            echo "::error::Arquivo de cobertura JaCoCo n√£o encontrado em target/site/jacoco/jacoco.xml"
            echo "Conte√∫do de target/site/jacoco:"
            ls -la target/site/jacoco || true
            exit 1
          fi
          

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            target
            target/site/jacoco/jacoco.xml
            *.jar

  docker-build-and-push:
    name: Build and Push Docker Image
    needs:  build_and_test
    runs-on: ubuntu-latest
    if: inputs.run_docker_build_and_push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          IMAGE_TAG="${{ needs.build_and_test.outputs.image_tag }}"
          echo "üê≥ Construindo imagem Docker com tag: $IMAGE_TAG"
          docker build -t ${{ inputs.app_name }}:$IMAGE_TAG .
          docker tag ${{ inputs.app_name }}:$IMAGE_TAG ${{ inputs.app_name }}:latest

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ inputs.dockerhub_username }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Tag Docker image for Docker Hub
        run: |
          IMAGE_TAG="${{ needs.build_and_test.outputs.image_tag }}"
          echo "üè∑Ô∏è  Criando tags para Docker Hub..."
          docker tag ${{ inputs.app_name }}:$IMAGE_TAG ${{ inputs.dockerhub_username }}/${{ inputs.app_name }}:$IMAGE_TAG
          docker tag ${{ inputs.app_name }}:$IMAGE_TAG ${{ inputs.dockerhub_username }}/${{ inputs.app_name }}:latest
          echo "‚úÖ Tags criadas: $IMAGE_TAG e latest"

      - name: Push Docker image to Docker Hub
        run: |
          IMAGE_TAG="${{ needs.build_and_test.outputs.image_tag }}"
          echo "üì§ Enviando imagens para Docker Hub..."
          docker push ${{ inputs.dockerhub_username }}/${{ inputs.app_name }}:$IMAGE_TAG
          docker push ${{ inputs.dockerhub_username }}/${{ inputs.app_name }}:latest
          echo "‚úÖ Imagens publicadas:"
          echo "  - ${{ inputs.dockerhub_username }}/${{ inputs.app_name }}:$IMAGE_TAG"
          echo "  - ${{ inputs.dockerhub_username }}/${{ inputs.app_name }}:latest"
